<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>D3 World Map</title>
	<style>
	#graph svg{
		background-color:#B5D0D0;
	}
	#states path {
		fill: #F1EEE8;
		stroke: #C6ACE8;
	}
	circle {
		
		fill-opacity: .6;
		stroke: #000;
	}
	</style>
	<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script src="https://code.jquery.com/ui/1.10.4/jquery-ui.min.js"></script>
	<script src="https://cdn.firebase.com/js/client/2.2.1/firebase.js"></script>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css" />
  </head>
 <body>
	<h2>
		World GDP
	</h2>
	<h3>
	expressed in Billion US dollar
	</h3>

	<div id="graph"></div>
	<p>
	<label for="year">Year :</label>
	<input type="text" id="year" style="border:0; color:#f6931f; font-weight:bold; " />
	</p>
	<div id="slider" style="width: 200px;"></div>
    <script>
		$("#slider").slider({
			value:2014,
			min: 1968,
			max: 2014,
			step: 1,
			slide: function( event, ui ) {
				$("#year").val(ui.value);
				redraw(ui.value.toString());
			}
		});
		$("#year").val($("#slider").slider("value") );
		var w = 1000;
		var h = 500;
		var geolist = new Firebase('https://torrid-inferno-9548.firebaseio.com/');
		var stategdp = new Firebase('https://team7project2.firebaseio.com/');
		/*var xy = d3.geo.equirectangular()
			.scale(150);*/
		var xy = d3.geo.equirectangular()
			.scale(150)
			.translate([w / 2, h / 2]);
		var path = d3.geo.path()
			.projection(xy);
		var svg = d3.select("#graph").insert("svg")
			.attr("width", w)
			.attr("height", h);
		var states = svg.append("g")
			.attr("id", "states");
		var circles = svg.append("g")
			.attr("id", "circles")
			.style("fill","steelblue");
		var labels = svg.append("g")
			.attr("id", "labels");
		var centered;
		geolist.on("value",function(snapshot){
			var data = snapshot.val();
			states.selectAll("path")
				.data(data.features)
			.enter().append("path")
				.attr("d", path)
				.on("mouseover", function(d) {
					d3.select(this).style("fill","#6C0");})
				.on("mouseout", function(d) {
					d3.select(this).style("fill","#F1EEE8");})	
		})
		var scalefactor=1./70000. ;
		stategdp.on("value",function(gdp){
			circles.selectAll("circle")
				.data(gdp.val())
			.enter()
			.append("circle")
				.attr("cx", function(d, i) { return xy([+d.longitude,+d.latitude])[0]; })
				.attr("cy", function(d, i) { return xy([+d.longitude,+d.latitude])[1]; })
				.attr("r",  function(d) { return (Math.sqrt(d["2014"]))*scalefactor; })				
					.on("mouseover",function(d){
                		d3.select(this).style("fill","#FC0");})
					.on("mouseout", function(d){
						d3.select(this).style("fill","steelblue");})
				.on("click", clicked);	 
			labels.selectAll("labels")
		      .data(gdp.val())
		    .enter()
		    .append("text")
		        .attr("x", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[0]; })
		        .attr("y", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[1]-15; })
		        .attr("dy", "1em")
		        .attr("text-anchor", "middle")
				.append("tspan")
					.text(function(d) { return d["Country Code"]})
					.attr("x", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[0]; })		
					.attr("dy", "1em")
			labels.selectAll("text")
				.append("tspan")
					.text(function(d) { return Math.round(d["2014"]/1000000000); })
					.attr("x", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[0]; })
					.attr("dy", "1em")
		});
		
		function clicked(d){
			var x, y, k
			q = xy("500","250")[0];
			z = xy("500","250")[1];
			if (d&&centered!==d.longitude) {
				x = xy([+d.longitude,+d.latitude])[0];
				y = xy([+d.longitude,+d.latitude])[1];
				//var centered = xy([+d.longitude,+d.latitude]);
				k = 3;
				centered = d.longitude;
				d3.selectAll("circle").style("opacity","0")
				d3.select(this)
					.style("opacity","1")
					.style("fill","transparent")
					.on("mouseover",function(d){
                		d3.select(this).style("fill","transparent");})
					.on("mouseout", function(d){
						d3.select(this).style("fill","transparent");})
					labels.transition()
						.text()				
			} else {
				x = q;
				y = z;
				k = 1;
				centered = null;
				console.log([d.longitude,d.latitude]);
				d3.selectAll("circle").style("opacity","1")
				d3.select(this)
					.style("fill","steelblue")
					.on("mouseover",function(d){
                		d3.select(this).style("fill","#FC0");})
					.on("mouseout", function(d){
						d3.select(this).style("fill","steelblue");})
				stategdp.on("value",function(gdp){
					labels.selectAll("labels")
						.data(gdp.val())
					.enter()
					.append("text")
							.attr("x", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[0]; })
							.attr("y", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[1]; })
							.attr("dy", "0.5em")
							.attr("text-anchor", "middle")
							.append("tspan")
								.text(function(d) { return d["Country Code"]})
								.attr("x", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[0]; })		
								.attr("dy", "1em")
					labels.selectAll("text")
						.append("tspan")
							.text(function(d) { return Math.round(d["2014"]/1000000000); })
							.attr("x", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[0]; })
							.attr("dy", "1em")
				});
			}
			states.classed("active", centered)
			circles.classed("active", centered)
			labels.classed("active", centered)
			states.transition()
				.duration(750)
				.attr("transform", "translate(" + q + "," + z + ")scale(" + k + ")translate(" + -x + "," + -y +  ")")
				
			circles.transition()
				.duration(750)
				.attr("transform", "translate(" + q + "," + z + ")scale(" + k + ")translate(" + -x + "," + -y +  ")")
				.style("stroke-width", 1.5 / k + "px")
			labels.transition()
				.duration(750)
				.attr("transform", "translate(" + q + "," + z + ")scale(" + k + ")translate(" + -x + "," + -y +  ")")		
		}		
		function redraw(year) {
			circles.selectAll("circle")
			.transition()
				.duration(1000).ease("linear")
				 .attr("r",  function(d) { return (Math.sqrt(d[year]))*scalefactor; })

			labels.selectAll("text")
					.text(function(d) { return d["Country Code"]})
					.attr("x", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[0]; })		
					.attr("dy", "1em")
			labels.selectAll("text")
				.append("tspan")
					.text(function(d) { return Math.round(d["2014"]/1000000000); })
					.attr("x", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[0]; })
					.attr("dy", "1em")
		};
		
    </script>
  </body>
</html>