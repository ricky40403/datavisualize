<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>D3 World Map</title>
	<style>
	#graph svg{
		background-color:#B5D0D0;
	}
	#states path {
		fill: #F1EEE8;
		stroke: #C6ACE8;
	}
	circle {		
		fill-opacity: .6;
		stroke: #000;
	}
	.d3-tip {
		line-height: 1;
		font-weight: bold;
		padding: 12px;
		background: rgba(0, 0, 0, 0.8);
		color: #fff;
		border-radius: 2px;
	}
	.d3-tip:after {
		box-sizing: border-box;
		display: inline;
		font-size: 10px;
		width: 100%;
		line-height: 1;
		color: rgba(0, 0, 0, 0.8);
		content: "\25BC";
		position: absolute;
		text-align: center;
	}
	.d3-tip.n:after {
		margin: -1px 0 0 0;
		top: 100%;
		left: 0;
	}
	</style>
	<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script src="https://code.jquery.com/ui/1.10.4/jquery-ui.min.js"></script>
	<script src="https://cdn.firebase.com/js/client/2.2.1/firebase.js"></script>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
	<link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css" />
  </head>
 <body>
	<h2>
		World GDP
	</h2>
	<h3>
	expressed in Billion US dollar
	</h3>	
	<div id="graph"></div>
	<div id="bar"></div>
	<p>
	<label for="year">Year :</label>
	<input type="text" id="year" style="border:0; color:#f6931f; font-weight:bold; " />
	</p>
	<div id="slider" style="width: 200px;"></div>
    <script>
		$("#slider").slider({
			value:2014,
			min: 1968,
			max: 2014,
			step: 1,
			slide: function( event, ui ) {
				$("#year").val(ui.value);
				redraw(ui.value.toString());
			}
		});
		$("#year").val($("#slider").slider("value") );
		var w = 1000;
		var h = 500;
		var bar;
		var tip = d3.tip().attr('class', 'd3-tip').html(function(d) { return d["properties"]["name"] });
		var geolist = new Firebase('https://torrid-inferno-9548.firebaseio.com/');
		var stategdp = new Firebase('https://team7project2.firebaseio.com/');
		var xy = d3.geo.equirectangular()
			.scale(150)
			.translate([w / 2, h / 2]);
		var path = d3.geo.path()
			.projection(xy);
		var svg = d3.select("#graph").insert("div").insert("svg")
			.attr("width", w)
			.attr("height", h)	
		var svgbar = d3.select("#bar").insert("div").insert("svg")
		var barHeight = 20;	
		var states = svg.append("g")
			.attr("id", "states");
		states.call(tip);
		var circles = svg.append("g")
			.attr("id", "circles")
			.style("fill","steelblue");
		var labels = svg.append("g")
			.attr("id", "labels");
		var centered;
		var randomColor = (function(){
			var golden_ratio_conjugate = 0.618033988749895;
			var h = Math.random();
			var hslToRgb = function (h, s, l){
			var r, g, b;
			if(s == 0){
				r = g = b = l; // achromatic
			}
			else{
				function hue2rgb(p, q, t){
					if(t < 0) t += 1;
					if(t > 1) t -= 1;
					if(t < 1/6) return p + (q - p) * 6 * t;
					if(t < 1/2) return q;
					if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
					return p;
				}
				var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
				var p = 2 * l - q;
				r = hue2rgb(p, q, h + 1/3);
				g = hue2rgb(p, q, h);
				b = hue2rgb(p, q, h - 1/3);
			}
			return '#'+Math.round(r * 255).toString(16)+Math.round(g * 255).toString(16)+Math.round(b * 255).toString(16);
			};
			return function(){
				h += golden_ratio_conjugate;
				h %= 1;
				return hslToRgb(h, 0.5, 0.60);
			};
		})();
		geolist.on("value",function(snapshot){
			var data = snapshot.val();
			states.selectAll("path")
				.data(data.features)
			.enter().append("path")
				.attr("d", path)
				.on("mouseover", function(d) {
						tip.show(d);
						d3.select(this).style("fill","#6C0");
				})
				.on("mouseout",function(d) {
						tip.hide(d);
						d3.select(this).style("fill","#F1EEE8");
				})		
			states.selectAll("path")
				.attr("class",function(d) { return d["properties"]["name"]})
		})
		var scalefactor=1./70000. ;
		stategdp.on("value",function(gdp){
			var color = randomColor();
			circles.selectAll("circle")
				.data(gdp.val())
			.enter()
			.append("circle")
				.attr("class",function(d) { return d["Country Code"]})
				.attr("cx", function(d, i) { return xy([+d.longitude,+d.latitude])[0]; })
				.attr("cy", function(d, i) { return xy([+d.longitude,+d.latitude])[1]; })
				.attr("r",  function(d) { return (Math.sqrt(d["2014"]))*scalefactor; })				
					.on("mouseover",function(d){
                		d3.select(this).style("fill","#FC0");})
					.on("mouseout", function(d){
						d3.select(this).style("fill","steelblue");})
				.on("click", function(d){
					clicked(d);
					redrawbar(d);
				});	 
			labels.selectAll("labels")
		      .data(gdp.val())
		    .enter()
		    .append("text")
		        .attr("x", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[0]; })
		        .attr("y", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[1]-15; })
		        .attr("dy", "1em")
		        .attr("text-anchor", "middle")
				.append("tspan")
					.text(function(d) { return d["Country Code"]})
					.attr("x", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[0]; })		
					.attr("dy", "1em")
			labels.selectAll("text")
				.append("tspan")
					.text(function(d) { return Math.round(d["2014"]/1000000000); })
					.attr("x", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[0]; })
					.attr("dy", "1em")
			bar =svgbar.attr("width", w).attr("height", gdp.val().length*20)
					.selectAll("g")
						.data(gdp.val())
					.enter().append("g")
						.attr("transform",function(d, i) { return "translate(0," + i *barHeight + ")"; })						
			bar.append("rect")
				.style("fill",randomColor)
				.attr("width", function(d) { return Math.round(d["2014"]/50000000000);})
					.attr("height", barHeight - 1)			
					.on("mouseover", function(d){
							circles.select("circle."+d["Country Code"] )
							.style("fill","#FC0");})
					.on("mouseout", function(d){
							circles.select("circle."+d["Country Code"] )
							.style("fill","steelblue");})
			bar.append("text")				
				.attr("x",function(d) { return Math.round(d["2014"]/50000000000)+10;})
				.attr("y", barHeight / 2)
				.attr("dy", ".35em")
				.text(function(d) { return Math.round(d["2014"]/1000000000)+"("+d["Country Name"]+")"; })
		})
		
		function clicked(d){
			var x, y, k
			q = xy("500","250")[0];
			z = xy("500","250")[1];
			if (d&&centered!==d.longitude) {
				x = xy([+d.longitude,+d.latitude])[0];
				y = xy([+d.longitude,+d.latitude])[1];
				k = 3;
				centered = d.longitude;
				d3.selectAll("circle").style("opacity","0")
				d3.select("circle."+d["Country Code"])
					.style("opacity","1")
					.style("fill","transparent")
					.on("mouseover",function(d){
                		d3.select("circle."+d["Country Code"]).style("fill","transparent");})
					.on("mouseout", function(d){
						d3.select("circle."+d["Country Code"]).style("fill","transparent");})
					labels.transition()
						.text()				
			} else {
				x = q;
				y = z;
				k = 1;
				centered = null;
				
				d3.selectAll("circle").style("opacity","1")
				d3.select("circle."+d["Country Code"])
					.style("fill","steelblue")
					.on("mouseover",function(d){
                		d3.select("circle."+d["Country Code"]).style("fill","#FC0");})
					.on("mouseout", function(d){
						d3.select("circle."+d["Country Code"]).style("fill","steelblue");})
				stategdp.on("value",function(gdp){
					labels.selectAll("labels")
						.data(gdp.val())
					.enter()
					.append("text")
							.attr("x", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[0]; })
							.attr("y", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[1]-15; })
							.attr("dy", "0.5em")
							.attr("text-anchor", "middle")
							.append("tspan")
								.text(function(d) { return d["Country Code"]})
								.attr("x", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[0]; })		
								.attr("dy", "1em")
					labels.selectAll("text")
						.append("tspan")
							.text(function(d) { return Math.round(d["2014"]/1000000000); })
							.attr("x", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[0]; })
							.attr("dy", "1em")
				});
			}
			states.classed("active", centered)
			circles.classed("active", centered)
			labels.classed("active", centered)
			states.transition()
				.duration(750)
				.attr("transform", "translate(" + q + "," + z + ")scale(" + k + ")translate(" + -x + "," + -y +  ")")
				
			circles.transition()
				.duration(750)
				.attr("transform", "translate(" + q + "," + z + ")scale(" + k + ")translate(" + -x + "," + -y +  ")")
				.style("stroke-width", 1.5 / k + "px")
			labels.transition()
				.duration(750)
				.attr("transform", "translate(" + q + "," + z + ")scale(" + k + ")translate(" + -x + "," + -y +  ")")		
		}
		function redrawbar(d){
			//bar =svgbar.attr("width", w).attr("height", d.length*20)
			console.log(d);
		}
		function redraw(year) {
			circles.selectAll("circle")
			.transition()
				.duration(1000).ease("linear")
				 .attr("r",  function(d) { return (Math.sqrt(d[year]))*scalefactor; })
			labels.selectAll("text")
					.text(function(d) { return d["Country Code"]})
					.attr("x", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[0]; })		
					.attr("dy", "1em")
			labels.selectAll("text")
				.append("tspan")
					.text(function(d) { return Math.round(d[year]/1000000000); })
					.attr("x", function(d, i) { return xy([+d["longitude"],+d["latitude"]])[0]; })
					.attr("dy", "1em")
			svgbar.selectAll("rect")
			.transition()
				.duration(100)
					.attr("width", function(d) { return Math.round(d[year]/50000000000);})
			bar.selectAll("text")
			.transition()
				.duration(100)
					.attr("x",function(d) { return Math.round(d[year]/50000000000)+10;})
					.text(function(d) { return Math.round(d[year]/1000000000)+"("+d["Country Name"]+")"; })
		};
		
    </script>
  </body>
</html>